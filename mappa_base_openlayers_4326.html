<!DOCTYPE html>
<html>
  <head>
    <title>Mappa con OpenLayers</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        font-family: 'Roboto', Arial, sans-serif;
      }
      #map {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
      }
      #toggleLayerPanel {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        cursor: pointer;
        font-size: 22px;
        padding: 0;
      }
      #toggleLayerPanel:hover {
        background: #f0f0f0;
      }
      #coordDisplay {
        position: absolute;
        bottom: 16px;
        left: 16px;
        z-index: 12;
        background: rgba(255,255,255,0.95);
        border-radius: 6px;
        padding: 6px 14px;
        font-size: 15px;
        color: #222;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        font-family: 'Roboto', Arial, sans-serif;
        pointer-events: none;
        min-width: 120px;
      }
      /* Rimosse regole duplicate o in conflitto per .ol-scale-line e .ol-scale-bar */
      .ol-scale-line {
        background: #1976d2 !important;
        border: 2px solid #fff !important;
        color: #fff !important;
        font-size: 15px !important;
        font-weight: 500 !important;
        border-radius: 6px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.18) !important;
        padding: 4px 14px !important;
        margin: 0 !important;
        min-width: 60px;
        max-width: 160px;
        text-align: left;
        pointer-events: auto;
        display: inline-block;
        overflow-x: hidden;
        letter-spacing: 0.5px;
      }
      .ol-scale-bar {
        display: none !important;
      }
      #backToMapBtn {
        position: absolute;
        right: 16px;
        bottom: 60px;
        left: auto;
        transform: none;
        z-index: 13;
        background: #fff;
        color: #222;
        border: 1px solid #bbb;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 13px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        font-family: 'Roboto', Arial, sans-serif;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.2s, color 0.2s;
      }
      #backToMapBtn:hover {
        background: #f0f0f0;
        color: #1976d2;
        border-color: #1976d2;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
  </head>
  <body>
    <button id="toggleLayerPanel" title="Layer GeoServer" style="position:absolute;top:10px;right:10px;z-index:11;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#1976d2" stroke-width="2" fill="#fff"/><path d="M7 12h10M12 7v10" stroke="#1976d2" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
    <button id="toggleBasemapPanel" title="Cambia Basemap" style="position:absolute;top:60px;right:10px;z-index:11;background:#fff;border:1px solid #ccc;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.10);cursor:pointer;font-size:22px;padding:0;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2" stroke="#1976d2" stroke-width="2" fill="#fff"/><path d="M3 17l4-4 4 4 4-4 4 4" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div id="layerPanel" style="display:none;position:absolute;top:50px;right:64px;z-index:10;background:#fff;border:1px solid #ccc;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:220px;">
      <label style="display:block;margin-bottom:6px;"><input type="checkbox" value="layer1"> Layer 1 (esempio)</label>
      <label style="display:block;margin-bottom:6px;"><input type="checkbox" value="layer2"> Layer 2 (esempio)</label>
    </div>
    <div id="basemapPanel" style="display:none;position:absolute;top:50px;right:64px;z-index:10;background:#fff;border:1px solid #ccc;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:180px;">
      <label style="display:block;margin-bottom:12px;"><input type="radio" name="basemap" value="none"> Nessuna basemap</label>
      <label style="display:block;margin-bottom:12px;"><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label>
      <label style="display:block;margin-bottom:0;"><input type="radio" name="basemap" value="sat"> Satellitare</label>
    </div>
    <div id="coordDisplay" style="position:absolute;bottom:16px;left:16px;z-index:12;background:rgba(255,255,255,0.95);border-radius:6px;padding:6px 14px;font-size:15px;color:#222;box-shadow:0 1px 4px rgba(0,0,0,0.08);font-family:'Roboto',Arial,sans-serif;pointer-events:none;min-width:120px;">
      Lat: &mdash; | Long: &mdash;
    </div>
    <div id="map"></div>
    <button id="backToMapBtn" title="Back to map">Back to map</button>
    <script type="text/javascript">
      // Basemap layers
      var osmBase = new ol.layer.Tile({
        source: new ol.source.OSM(),
        visible: true
      });
      var emptyBase = new ol.layer.Tile({
        source: new ol.source.TileImage({
          tileUrlFunction: function() { return ""; }
        }),
        visible: false
      });
      var satBase = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          attributions: 'Tiles © Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }),
        visible: false
      });
      // Ricrea la mappa con i nuovi basemap
      var map = new ol.Map({
        target: 'map',
        layers: [osmBase, emptyBase, satBase],
        view: new ol.View({
          center: [17.6791, 43.9159], // centroide Bosnia Erzegovina
          zoom: 8,
          projection: 'EPSG:4326'
        })
      });
      // Definisci i layer WMS (sostituisci con i tuoi dati reali)
      var wmsLayers = {
        'layer1': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://www.gis-geoserver.polimi.it/geoserver/ows?', // Corretto: termina con /ows?
            params: {
              'LAYERS': 'gisgeoserver_18:BOSNIA_CAMS_NO2_2022_12',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer2': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer2',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer3': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer3',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer4': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer4',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer5': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer5',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer6': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer6',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer7': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer7',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer8': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer8',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer9': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer9',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer10': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer10',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer11': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer11',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer12': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer12',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer13': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer13',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer14': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer14',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer15': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer15',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer16': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer16',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer17': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer17',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        }),
        'layer18': new ol.layer.Tile({
          source: new ol.source.TileWMS({
            url: 'https://TUO_GEOSERVER/geoserver/ows?',
            params: {
              'LAYERS': 'workspace:layer18',
              'TILED': true,
              'FORMAT': 'image/png',
              'TRANSPARENT': true
            },
            serverType: 'geoserver',
            crossOrigin: 'anonymous'
          }),
          visible: false
        })
      };
      // Aggiungi tutti i layer WMS alla mappa (inizialmente invisibili)
      Object.values(wmsLayers).forEach(function(layer) {
        map.addLayer(layer);
      });
      // Gestione pannello layer
      var layerPanelBtn = document.getElementById('toggleLayerPanel');
      var basemapPanelBtn = document.getElementById('toggleBasemapPanel');
      var layerPanelDiv = document.getElementById('layerPanel');
      var basemapPanelDiv = document.getElementById('basemapPanel');
      layerPanelBtn.addEventListener('click', function() {
        // Chiudi il pannello basemap se aperto
        if (basemapPanelDiv.style.display === 'block') {
          basemapPanelDiv.style.display = 'none';
        }
        layerPanelDiv.style.display = (layerPanelDiv.style.display === 'none' ? 'block' : 'none');
      });
      basemapPanelBtn.addEventListener('click', function() {
        // Chiudi il pannello layer se aperto
        if (layerPanelDiv.style.display === 'block') {
          layerPanelDiv.style.display = 'none';
        }
        basemapPanelDiv.style.display = (basemapPanelDiv.style.display === 'none' ? 'block' : 'none');
      });
      document.querySelectorAll('#basemapPanel input[name=basemap]').forEach(function(radio) {
        radio.addEventListener('change', function(e) {
          var val = e.target.value;
          osmBase.setVisible(val === 'osm');
          emptyBase.setVisible(val === 'none');
          satBase.setVisible(val === 'sat');
        });
      });
      // Nomi personalizzati per i layer
      var layerNames = [
        'Bosnia Boundaries',
        'Cantons',
        'Urban Areas',
        'Land Cover 2022 (Reclassified)',
        'Population Quantiles (Reclassified)',
        'NO₂ CAMS 12/2022',
        'NO₂ Average 2022',
        'NO₂ Concentration 2020',
        'NO₂ AAD Map 2022',
        'NO₂ Zonal Statistics 2013–2022',
        'NO₂ Bivariate Map 2020',
        'NO₂ Chart 2020',
        'PM2p5 CAMS 12/2022',
        'PM2p5 Average 2022',
        'PM2p5 Concentration 2020',
        'PM2p5 AAD Map 2022',
        'PM2p5 Zonal Statistics 2013–2022',
        'PM2p5 Bivariate Map 2020'
      ];
      // Aggiorna il pannello layer con gruppi NO2 e PM2.5 chiudibili
      var layerPanel = document.getElementById('layerPanel');
      layerPanel.innerHTML = '';
      // Gruppi
      var groupNO2 = document.createElement('details');
      groupNO2.style.marginBottom = '16px'; // Spaziatura coerente con i layer
      var groupNO2Summary = document.createElement('summary');
      groupNO2Summary.textContent = 'NO₂ Layers';
      groupNO2Summary.style.marginBottom = '12px'; // Spaziatura sotto il summary
      groupNO2.appendChild(groupNO2Summary);
      var groupPM25 = document.createElement('details');
      groupPM25.style.marginBottom = '0px'; // Ridotto lo spazio bianco sotto la sezione PM2.5
      var groupPM25Summary = document.createElement('summary');
      groupPM25Summary.textContent = 'PM2.5 Layers';
      groupPM25Summary.style.marginBottom = '12px'; // Spaziatura sotto il summary
      groupPM25.appendChild(groupPM25Summary);
      // Altri layer
      for (var i = 1; i <= 18; i++) {
        var label = document.createElement('label');
        label.style.display = 'block';
        label.style.marginBottom = '16px'; // aumentato da 6px a 16px per maggiore leggibilità
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = 'layer' + i;
        label.appendChild(checkbox);
        var nome = layerNames[i-1] || ('Layer ' + i);
        label.appendChild(document.createTextNode(' ' + nome));
        // Raggruppa
        if (nome.startsWith('NO₂')) {
          groupNO2.appendChild(label);
        } else if (nome.startsWith('PM2p5')) {
          groupPM25.appendChild(label);
        } else {
          layerPanel.appendChild(label);
        }
      }
      layerPanel.appendChild(groupNO2);
      layerPanel.appendChild(groupPM25);
      // Ricollega i listener per i nuovi checkbox
      document.querySelectorAll('#layerPanel input[type=checkbox]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function(e) {
          var key = e.target.value;
          wmsLayers[key].setVisible(e.target.checked);
        });
      });
      // Mostra lat/lon del cursore
      var coordDiv = document.getElementById('coordDisplay');
      map.on('pointermove', function(evt) {
        var coord = evt.coordinate;
        if (coord) {
          var lon = coord[0].toFixed(5);
          var lat = coord[1].toFixed(5);
          coordDiv.innerHTML = 'Lat: ' + lat + ' | Long: ' + lon;
        } else {
          coordDiv.innerHTML = 'Lat: &mdash; | Long: &mdash;';
        }
      });
      // Pulsante back to map (centroide Bosnia Erzegovina: lon=17.6791, lat=43.9159)
      document.getElementById('backToMapBtn').addEventListener('click', function() {
        map.getView().animate({
          center: [17.6791, 43.9159],
          zoom: 8,
          duration: 600
        });
      });
    </script>
  </body>
</html>
